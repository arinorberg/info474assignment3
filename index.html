<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Assignment 3</title>
	<script type="text/javascript" src="https://d3js.org/d3.v4.min.js"></script>
  <link href="./css/nouislider.min.css" rel="stylesheet">
	<link rel="stylesheet" type="text/css" href="./css/style.css"></link>
</head>
<body>

  <script src="./js/nouislider.min.js"></script>
  <script src="https://d3js.org/d3-color.v1.min.js"></script>
  <script src="https://d3js.org/d3-interpolate.v1.min.js"></script>
  <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>

	<!-- slider from lecture -->
	<script src="./js/jquery-3.3.1.min.js"></script>
	<script src="./js/jquery-ui-1.12.1.custom/jquery-ui.min.js"></script>
	<!-- <script type="text/javascript" src="http//code.jquery.com/jquery-1.10.2.js"></script>
	<script type="text/javascript" src="http//code.jquery.com/ui/1.11.1/jqueryui.js"></script> --> -->

	<!-- dropdowns -->
	<div class="dropdowns">
		<p>Choose X variable</p>
		<select id="dropdownX"></select>
		<p>Choose Y variable</p>
		<select id="dropdownY"></select>
		<p>Choose Color variable </p>
		<select id="dropdownColor"></select>
	</div>

	<!-- reverse button-->
	<div class="button">
			<button id="reverse">Reverse Axis</button>
	</div>

<!-- slider from online - attempt3 -->
<p>filter X</p>
<input id="xVal" type="range" min="0" max="1" step="0.1" value="0.5"/>

<p>filter Y</p>
<input id="yVal" type="range" min="0" max="1" step="0.1" value="0.5"/>


  <script>



// layout based on: http://blockbuilder.org/Jverma/076377dd0125b1a508621441752735fc
	var margin = {top: 30, right: 50, bottom: 40, left:40};
	var width = 700 - margin.left - margin.right;
	var height = 575 - margin.top - margin.bottom;
	var svg = d3.select('body')
		.append('svg')
		.attr('width', width + margin.left + margin.right)
		.attr('height', height + margin.top + margin.bottom)
	.append('g')
		.attr('transform', 'translate(' + margin.left + ',' + margin.top + ')');
	// The API for scales have changed in v4. There is a separate module d3-scale which can be used instead. The main change here is instead of d3.scale.linear, we have d3.scaleLinear.
	var xScale = d3.scaleLinear()
		.range([0, width]);
	var yScale = d3.scaleLinear()
		.range([height, 0]);
	// square root scale.
	var radius = d3.scaleSqrt()
		.range([2,5]);
	// the axes are much cleaner and easier now. No need to rotate and orient the axis, just call axisBottom, axisLeft etc.
	var xAxis = d3.axisBottom()
		.scale(xScale);
	var yAxis = d3.axisLeft()
		.scale(yScale);
	// again scaleOrdinal
	var color = d3.scaleOrdinal(d3.schemeCategory20);
	d3.csv('./data/Boston.csv', function(error, data){
		var variables = d3.keys(data[0]);
		data.forEach(function(d){
       d.crim = +d.crim;
			 d.zn = +d.zn;
			 d.indus = +d.indus;
			 d.chas = +d.chas;
			 d.nox = +d.nox;
			 d.rm = +d.rm
			 d.age = +d.age;
			 d.dis = +d.dis;
			 d.rad= +d.rad;
			 d.tax = +d.tax;
			 d.ptratio =+d.ptratio;
			 d.b = +d.b;
       d.medv = +d.medv;
		});
		var dropdown_options = variables


		// Get nice name of variable
		function getNiceName(selected) {
			var niceName = selected;
			if (selected == "crim") {
				niceName = "Per Capita Crime Rate"
			} else if (selected == "zn") {
				niceName = "Proportion of Residential Land Zoned for Lots"
			} else if (selected == "indus") {
				niceName = "Proportion of Non-retail Business Acres"
			} else if (selected == "chas") {
				niceName = "Tract Bounds the Charles River"
			} else if (selected == "nox") {
				niceName = "Nitric Oxides Concentration Parts (per 10 million)"
			} else if (selected == "rm") {
				niceName = "Average Number of Rooms per Dwelling"
			} else if (selected == "age") {
				niceName = "Proportion of Owner-Occupied Units Built Prior to 1940"
			} else if (selected == "dis") {
				niceName = "Weighted Distances to Five Boston Employment Centres"
			} else if (selected == "rad") {
				niceName = "Index of Accessibility to Radial Highways"
			} else if (selected == "tax") {
				niceName = "Full-value Property-Tax Rate per $10,000"
			} else if (selected == "ptratio") {
				niceName = "Pupil-teacher Ratio"
			} else if (selected == "B") {
				niceName = "Proportion of Blacks"
			} else if (selected == "lstat") {
				niceName = "% Lower Status of the Population"
			} else {
				niceName = "Median Value of Owner-Occupied Homes ($1000's)"
			}
			return niceName;
		}

		// default
		var selected_x = "crim";
		var selected_y = "medv";
		var selected_color = "chas";
		var niceNameX = getNiceName(selected_x);
		var niceNameY = getNiceName(selected_y);
		var niceNameColor = getNiceName(selected_color);
		var maxX = d3.max(data, function(d) { return d[selected_x]});
		var maxY = d3.max(data, function(d) { return d[selected_y]});

		document.getElementById('xVal').min = 0;
		document.getElementById('xVal').max = maxX;
		document.getElementById('xVal').step = maxX / 10;
		document.getElementById('xVal').value = maxX / 2;

		document.getElementById('yVal').min = 0;
		document.getElementById('yVal').max = maxY;
		document.getElementById('yVal').step = maxY / 10;
		document.getElementById('yVal').value= maxY / 2;

		updateGraph(selected_x, selected_y, selected_color, maxX, maxY);


		// Choose X variable
		d3.select("#dropdownX")
		.selectAll("option")
		.data(dropdown_options)
		.enter()
		.append("option")
		.attr("value", function(option) { return option; })
		.text(function(option) { return option; });
		var dropDown = d3.select("#dropdownX");
		dropDown.on("change", function() {
			selected_x = d3.event.target.value;
			niceNameX = getNiceName(selected_x);
			document.getElementById('xVal').min = 0;
			document.getElementById('xVal').max = maxX;
			document.getElementById('xVal').step = maxX / 10;
			document.getElementById('xVal').value = maxX / 2;
			updateGraph(selected_x, selected_y, selected_color, maxX, maxY)
		});
		// Choose Y variable
		d3.select("#dropdownY")
		.selectAll("option")
		.data(dropdown_options)
		.enter()
		.append("option")
		.attr("value", function(option) { return option; })
		.text(function(option) { return option; });
		var dropDown = d3.select("#dropdownY");
		dropDown.on("change", function() {
			selected_y = d3.event.target.value;
			niceNameY = getNiceName(selected_y);
			document.getElementById('yVal').min = 0;
			document.getElementById('yVal').max = maxY;
			document.getElementById('yVal').step = maxY / 10;
			document.getElementById('yVal').value= maxY / 2;
			updateGraph(selected_x, selected_y, selected_color, maxX, maxY);
		});
		// Choose color variable
		d3.select("#dropdownColor")
		.selectAll("option")
		.data(dropdown_options)
		.enter()
		.append("option")
		.attr("value", function(option) { return option; })
		.text(function(option) { return option; });
		var dropDown = d3.select("#dropdownColor");
		dropDown.on("change", function() {
			selected_color = d3.event.target.value;
			niceNameColor = getNiceName(selected_color);
			updateGraph(selected_x, selected_y, selected_color, maxX, maxY);
		});

		function reverse(selected_x, selected_y, selected_color) {
			updateGraph(selected_x, selected_y, selected_color, maxX, maxY);
		}

		// Choose color variable
		var button = d3.select("#reverse");
		button.on("click", function() {
			reverse(selected_y, selected_x, selected_color, maxX, maxY);
			var temp = selected_y;
			selected_y = selected_x;
			selected_x = temp;
		});



		// slider from online - attempt3
		document.getElementById('xVal').addEventListener('change', function() {
			maxX = this.value;
			updateGraph(selected_x, selected_y, selected_color, maxX, maxY)
		});

		// slider from online - attempt3
		document.getElementById('yVal').addEventListener('change', function() {
			maxY = this.value;
			updateGraph(selected_x, selected_y, selected_color, maxX, maxY)
		});

  // plot graph using selected x and y variables
	function updateGraph(selected_x, selected_y, selected_color, maxX, maxY) {
		console.log("x: " + selected_x)
		console.log("y: " + selected_y)
		console.log("color: " + selected_color)
		d3.select("svg").remove();
		var svg = d3.select('body')
			.append('svg')
			.attr('width', width + margin.left + margin.right)
			.attr('height', height + margin.top + margin.bottom)
		.append('g')
			.attr('transform', 'translate(' + margin.left + ',' + margin.top + ')');
    xScale.domain(d3.extent(data, function(d){
			if (d[selected_x] < maxX) {
				return d[selected_x];
			}
		})).nice();
		yScale.domain(d3.extent(data, function(d){
			if (d[selected_y] < maxY) {
				return d[selected_y];
			}
		})).nice();
  // });
		// radius.domain(d3.extent(data, function(d){
		// 	return d.PetalLength;
		// })).nice()
    ;
    svg.style("background-color", "#515A5A");
		// adding axes is also simpler now, just translate x-axis to (0,height) and it's alread defined to be a bottom axis.
		svg.append('g')
			.attr('transform', 'translate(0,' + height + ')')
			.attr('class', 'x axis')
			.call(xAxis);
		// y-axis is translated to (0,0)
		svg.append('g')
			.attr('transform', 'translate(0,0)')
			.attr('class', 'y axis')
			.call(yAxis);

		function translateDummyVar (d, selected) {
				 if (d[selected] == 0) {
					 return "no"
				 } else {
					 return "yes"
				 }
		}
    // add points to graph
		var bubble = svg.selectAll('.bubble')
			.data(data)
			.enter().append('circle')
			.attr('class', 'bubble')
			.attr('cx', function(d){return xScale(d[selected_x]);})
			.attr('cy', function(d){ return yScale(d[selected_y]); })
			.attr('r', 5)
			.style('fill', function(d){ return d3.interpolateBuPu(d[selected_color]) });
    // hover tooltip
		bubble.append('title')
			.attr('x', function(d){ return radius(1); })
			.text(function(d){
        // translate dummy variables for readability
				var xval  = d[selected_x];
				var yval  = d[selected_y];
				var colorval  = d[selected_color];
				if (selected_x =='chas') {
						xval = translateDummyVar(d, selected_x);
				}
				if (selected_y =='chas') {
						yval = translateDummyVar(d, selected_y);
				}
				if (selected_color =='chas') {
						colorval = translateDummyVar(d, selected_color);
				}
        var tooltip = "X: " + niceNameX + " = " + xval + "\nY: " + niceNameY + " = " + yval + "\nColor: " + niceNameColor + " = " + colorval
				return  tooltip;
			});
    // adding title
		svg.append("text")
        .attr("x", (width / 2))
        .attr("y", 0 - (margin.top / 2))
        .attr("text-anchor", "middle")
        .style("font-size", "16px")
        .text(niceNameX + " vs. " + niceNameY);
		// adding label. For x-axis, and for y-axis
		svg.append('text')
			.attr('x', 5)
			.attr('y', 15)
			.attr('class', 'label')
      .text(selected_x);
		svg.append('text')
			.attr('x', width)
			.attr('y', height - 5)
			.attr('text-anchor', 'end')
			.attr('class', 'label')
			.text(selected_y);
		// I feel I understand legends much better now.
		// define a group element for each color i, and translate it to (0, i * 20).
		var legend = svg.selectAll('legend')
			.data(color.domain())
			.enter().append('g')
			.attr('class', 'legend')
			.attr('transform', function(d,i){ return 'translate(0,' + i * 20 + ')'; });
		// give x value equal to the legend elements.
		// no need to define a function for fill, this is automatically fill by color.
		legend.append('rect')
			.attr('x', width)
			.attr('width', 18)
			.attr('height', 18)
			.style('fill', color);
		// add text to the legend elements.
		// rects are defined at x value equal to width, we define text at width - 6, this will print name of the legends before the rects.
		legend.append('text')
			.attr('x', width - 6)
			.attr('y', 9)
			.attr('dy', '.35em')
			.style('text-anchor', 'end')
			.text(function(d){ return d; });
		// d3 has a filter fnction similar to filter function in JS. Here it is used to filter d3 components.
		legend.on('click', function(type){
			d3.selectAll('.bubble')
				.style('opacity', 0.15)
				.filter(function(d){
					return d.chas == type;
				})
				.style('opacity', 1);
		})
	}
    function fillBubble(h) {
      svg.selectAll('.bubble').call(function(b) {
        if (b.cx < h) {
          console.log(b.cx)
          b.style("fill", "#000000");
        }
      });
    }
    fillBubble(20);
    function hue(h) {
      // console.log(h)
      handle.attr("cx", xScale(h));
      console.log(handle.cx)
      svg.style("background-color", "#515A5A");
      fillBubble(h);
    }
    function addClassFor(element, className, duration) {
    	element.classList.add(className);
    	setTimeout(function(){
    		element.classList.remove(className);
    	}, duration);
    }
	})
</script>

</body>
</html>
